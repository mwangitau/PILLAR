{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile within the Pillar application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "onboardingDataId": {
          "type": "string",
          "description": "Reference to OnboardingData. (Relationship: UserProfile 1:1 OnboardingData)"
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "onboardingDataId"
      ]
    },
    "OnboardingData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OnboardingData",
      "type": "object",
      "description": "Stores the data collected during the user onboarding process.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the OnboardingData entity."
        },
        "answers": {
          "type": "string",
          "description": "A json string with answers to onboarding questions."
        }
      },
      "required": [
        "id",
        "answers"
      ]
    },
    "Plan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Plan",
      "type": "object",
      "description": "Represents a personalized plan generated by the AI.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Plan entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Plan)"
        },
        "content": {
          "type": "string",
          "description": "The content of the generated plan."
        },
        "createdAt": {
          "type": "string",
          "description": "The date and time when the plan was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userProfileId",
        "content",
        "createdAt"
      ]
    },
    "Habit": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Habit",
      "type": "object",
      "description": "Represents a user-defined habit or routine.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Habit entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Habit)"
        },
        "name": {
          "type": "string",
          "description": "The name of the habit."
        },
        "description": {
          "type": "string",
          "description": "A description of the habit."
        },
        "schedule": {
          "type": "string",
          "description": "A JSON string representing the habit's schedule."
        }
      },
      "required": [
        "id",
        "userProfileId",
        "name",
        "description",
        "schedule"
      ]
    },
    "JournalEntry": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "JournalEntry",
      "type": "object",
      "description": "Represents a user's journal entry.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the JournalEntry entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N JournalEntry)"
        },
        "content": {
          "type": "string",
          "description": "The content of the journal entry."
        },
        "mood": {
          "type": "string",
          "description": "The mood associated with the journal entry."
        },
        "sentiment": {
          "type": "number",
          "description": "The sentiment score of the journal entry."
        },
        "createdAt": {
          "type": "string",
          "description": "The date and time when the journal entry was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userProfileId",
        "content",
        "mood",
        "sentiment",
        "createdAt"
      ]
    },
    "AccountabilityPartner": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AccountabilityPartner",
      "type": "object",
      "description": "Represents an accountability partner for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AccountabilityPartner entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N AccountabilityPartner)"
        },
        "partnerEmail": {
          "type": "string",
          "description": "The email address of the accountability partner.",
          "format": "email"
        },
        "permissions": {
          "type": "string",
          "description": "A JSON string representing the permissions granted to the accountability partner."
        },
        "consentLog": {
          "type": "string",
          "description": "A log of consent and interactions with the accountability partner."
        }
      },
      "required": [
        "id",
        "userProfileId",
        "partnerEmail",
        "permissions",
        "consentLog"
      ]
    },
    "FinanceRecord": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "FinanceRecord",
      "type": "object",
      "description": "Represents a financial record for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the FinanceRecord entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N FinanceRecord)"
        },
        "type": {
          "type": "string",
          "description": "The type of financial record (income, expense, tithe)."
        },
        "category": {
          "type": "string",
          "description": "The category of the financial record."
        },
        "amount": {
          "type": "number",
          "description": "The amount of the financial record."
        },
        "date": {
          "type": "string",
          "description": "The date of the financial record.",
          "format": "date-time"
        },
        "description": {
          "type": "string",
          "description": "Description of the transaction"
        }
      },
      "required": [
        "id",
        "userProfileId",
        "type",
        "category",
        "amount",
        "date",
        "description"
      ]
    },
    "Report": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Report",
      "type": "object",
      "description": "Represents a generated report (manual, accountability, journal, finance).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Report entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Report)"
        },
        "type": {
          "type": "string",
          "description": "The type of report (manual, accountability, journal, finance)."
        },
        "s3Url": {
          "type": "string",
          "description": "The URL of the report stored in S3."
        },
        "generatedAt": {
          "type": "string",
          "description": "The date and time when the report was generated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userProfileId",
        "type",
        "s3Url",
        "generatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/userProfiles/{userProfileId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. The `userProfileId` is used to identify the user. Includes user's `name`, `email` and a reference to `onboardingDataId`",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            }
          ]
        }
      },
      {
        "path": "/onboardingData/{onboardingDataId}",
        "definition": {
          "entityName": "OnboardingData",
          "schema": {
            "$ref": "#/backend/entities/OnboardingData"
          },
          "description": "Stores onboarding data for users, identified by `onboardingDataId`. Includes user's onboarding `answers`.",
          "params": [
            {
              "name": "onboardingDataId",
              "description": "The unique identifier for the onboarding data."
            }
          ]
        }
      },
      {
        "path": "/users/{userProfileId}/plans/{planId}",
        "definition": {
          "entityName": "Plan",
          "schema": {
            "$ref": "#/backend/entities/Plan"
          },
          "description": "Stores personalized plans for each user. Identified by `planId`. Includes the `content` of the plan and the `createdAt` timestamp.",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            },
            {
              "name": "planId",
              "description": "The unique identifier for the plan."
            }
          ]
        }
      },
      {
        "path": "/users/{userProfileId}/habits/{habitId}",
        "definition": {
          "entityName": "Habit",
          "schema": {
            "$ref": "#/backend/entities/Habit"
          },
          "description": "Stores user-defined habits. Identified by `habitId`. Includes habit `name`, `description`, and `schedule`.",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            },
            {
              "name": "habitId",
              "description": "The unique identifier for the habit."
            }
          ]
        }
      },
      {
        "path": "/users/{userProfileId}/journalEntries/{journalEntryId}",
        "definition": {
          "entityName": "JournalEntry",
          "schema": {
            "$ref": "#/backend/entities/JournalEntry"
          },
          "description": "Stores journal entries for each user. Identified by `journalEntryId`. Includes `content`, `mood`, `sentiment`, and `createdAt`.",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            },
            {
              "name": "journalEntryId",
              "description": "The unique identifier for the journal entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userProfileId}/accountabilityPartners/{accountabilityPartnerId}",
        "definition": {
          "entityName": "AccountabilityPartner",
          "schema": {
            "$ref": "#/backend/entities/AccountabilityPartner"
          },
          "description": "Stores accountability partner information for each user. Identified by `accountabilityPartnerId`. Includes `partnerEmail`, `permissions`, and `consentLog`.",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            },
            {
              "name": "accountabilityPartnerId",
              "description": "The unique identifier for the accountability partner."
            }
          ]
        }
      },
      {
        "path": "/users/{userProfileId}/financeRecords/{financeRecordId}",
        "definition": {
          "entityName": "FinanceRecord",
          "schema": {
            "$ref": "#/backend/entities/FinanceRecord"
          },
          "description": "Stores financial records for each user. Identified by `financeRecordId`. Includes `type`, `category`, `amount`, `date` and `description`.",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            },
            {
              "name": "financeRecordId",
              "description": "The unique identifier for the finance record."
            }
          ]
        }
      },
      {
        "path": "/users/{userProfileId}/reports/{reportId}",
        "definition": {
          "entityName": "Report",
          "schema": {
            "$ref": "#/backend/entities/Report"
          },
          "description": "Stores generated reports for each user. Identified by `reportId`. Includes `type`, `s3Url`, and `generatedAt`.",
          "params": [
            {
              "name": "userProfileId",
              "description": "The unique identifier for the user profile."
            },
            {
              "name": "reportId",
              "description": "The unique identifier for the report."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure Authorization Independence, clarity, and scalability for the Pillar application. It leverages path-based ownership for user-specific data and denormalization to avoid complex security rules. Here's a breakdown:\n\n*   **Authorization Independence:** Achieved by storing all data directly under the user's ID (`/users/{userId}`). This eliminates the need for `get()` calls in security rules to check parent document properties. For example, `plans`, `habits`, `journalEntries`, `accountabilityPartners`, `financeRecords`, and `reports` are all stored under `/users/{userId}`, ensuring that access control can be determined based solely on the requesting user's `uid` and the document's path.\n*   **QAPs (Rules are not Filters):** Segregation is used to ensure that list operations are secure. All data under `/users/{userId}` is private to the user, ensuring that listing resources under a user will never expose data that the user should not have access to.\n*   **User Profiles:** User profile data and onboarding data are kept separate in `/userProfiles/{userProfileId}` and `/onboardingData/{onboardingDataId}` respectively, and linked to the user via the `userProfileId` and `onboardingDataId` in the user's document, although they are still exclusively owned and managed by the user, allowing profile data to be updated without affecting other user data.\n*   **1:N Relationships:** Entities like `Plan`, `Habit`, `JournalEntry`, `AccountabilityPartner`, `FinanceRecord`, and `Report` are stored as subcollections under `/users/{userId}`, reflecting a 1:N relationship between the user and these entities. This structure simplifies querying and ensures that all related data is easily accessible and manageable.\n*   **No Custom Claims (DBAC):** Authorization is based solely on `request.auth.uid` and data stored directly in the database, avoiding the complexity and potential security issues associated with custom claims.\n*   **Scalability:** The design avoids deeply nested subcollections, which can impact performance. Data is organized in a way that allows for efficient querying and retrieval, even as the application scales.\n*   **Predictable Schema:** Enforces semantic naming conventions. For example, user ID is consistently referred to as `userProfileId` where relationships exist."
  }
}